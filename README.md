# Wan2.2 Video Generator

A local application for generating long-form videos using ComfyUI and Wan2.2. Since Wan2.2 is limited to ~5 second clips, this app enables creating longer videos by breaking them into segments and automatically stitching them together.

## Prerequisites

- **Python 3.10+** - For the backend API
- **Node.js 18+** - For the React frontend
- **ComfyUI** - Running locally with Wan2.2 models installed
- **ffmpeg** - For video stitching (must be in PATH)

## Quick Start

### Backend

```bash
cd backend
pip install -r requirements.txt
python main.py
```

The backend API runs on **http://localhost:8000**.

API documentation is available at http://localhost:8000/docs.

### React App (Frontend)

```bash
cd react-app
npm install
npm run dev
```

The frontend runs on **http://localhost:5173**.

### Production Build

To build the React app for production:

```bash
cd react-app
npm run build
npm run preview  # Preview the production build
```

## Configuration

The application expects ComfyUI to be running at `http://localhost:8188` by default. Settings can be configured through the UI's Settings page.

---

## Overview

The Wan2.2 Video Generator connects to a locally running ComfyUI server to generate Wan2.2-based videos. It manages the complexity of creating longer videos by handling segment generation, frame extraction, and video stitching automatically.

## How It Works

### Segments

A **segment** is a short video clip generated by ComfyUI (typically ~5 seconds max).

To create a longer video, the user defines:
- **Total duration**
- **Number of segments**

Example: A 10-second video = 2 segments x 5 seconds each.

### Segment Generation Workflow

1. **Segment 1**: The user provides a starting image and prompt. The app injects these into a Wan2.2 i2v workflow template and submits it to ComfyUI.

2. **Subsequent Segments**: When a segment completes, the backend extracts the final frame of the output clip and uses it as the starting image for the next segment. The user can provide a new prompt for each segment.

3. **Final Video**: After all segments are generated, the backend automatically stitches the segment videos together using ffmpeg.

## Jobs and Queueing

### Jobs

A **job** is a complete video request consisting of:
- One or more video segments
- Associated inputs (starting images, prompts)
- Workflow settings
- The final stitched output

### Local Job Queue

To avoid overwhelming ComfyUI, the backend includes a lightweight queue system that:
- Stores pending jobs
- Submits only one segment at a time to ComfyUI
- Waits for ComfyUI processing to complete
- Fetches outputs and moves to the next segment
- Marks a job complete when all segments are finished and stitched

## Architecture

### Frontend (React + Vite)

- **React 19** with React Router for navigation
- **Material UI 7** for components
- Communicates with the backend via REST API

Responsibilities:
- Creating and configuring jobs (duration, segment count, prompts, starting image)
- Displaying segment outputs, final-frame previews, and job status
- Playing the final stitched video

### Backend (Python + FastAPI)

- **FastAPI** for the REST API
- **SQLite** for job/segment persistence
- **httpx** for async ComfyUI communication

Responsibilities:
- REST API endpoints for job creation, status, and results
- Managing the local job queue
- Submitting workflows to ComfyUI and polling for results
- Downloading segment outputs and extracting final frames
- Stitching all segments into the final video

The backend holds Wan2.2 i2v workflow templates and injects variables like:
- Starting image
- Prompt
- Seed (optional)
- Duration

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/jobs` | List all jobs |
| POST | `/api/jobs` | Create a new job |
| GET | `/api/jobs/{id}` | Get job details |
| DELETE | `/api/jobs/{id}` | Delete a job |
| GET | `/api/queue/status` | Get queue status |
| POST | `/api/queue/start` | Start the queue |
| POST | `/api/queue/stop` | Stop the queue |
| GET | `/health` | Health check |

Full API documentation available at `/docs` when the backend is running.
